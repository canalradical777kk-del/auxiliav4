<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Keys - Sistema com Tempo/Créditos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* TODO O SEU CSS AQUI (mantido igual) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f1f5f9;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            border: 1px solid #334155;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
        }
        
        .main-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .main-panel {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #334155;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }
        
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            font-size: 1.8rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 10px;
            color: #f1f5f9;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 25px;
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: linear-gradient(90deg, #2563eb, #4f46e5);
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(37, 99, 235, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .btn-success:hover {
            background: linear-gradient(90deg, #059669, #047857);
            box-shadow: 0 7px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .btn-warning:hover {
            background: linear-gradient(90deg, #d97706, #b45309);
            box-shadow: 0 7px 15px rgba(245, 158, 11, 0.3);
        }
        
        .key-display {
            background: #0f172a;
            border: 2px dashed #475569;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            word-break: break-all;
            color: #22d3ee;
        }
        
        .key-display.expired {
            color: #ef4444;
            border-color: #ef4444;
        }
        
        .key-display.active {
            color: #10b981;
            border-color: #10b981;
        }
        
        .keys-list {
            grid-column: 1 / -1;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #334155;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #1e293b;
            padding: 15px;
            text-align: left;
            color: #60a5fa;
            font-weight: 600;
        }
        
        td {
            padding: 15px;
            border-top: 1px solid #334155;
        }
        
        .status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-expired {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .status-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .action-btn {
            padding: 6px 12px;
            background: #334155;
            border: none;
            border-radius: 6px;
            color: #cbd5e1;
            cursor: pointer;
            transition: background 0.3s;
            margin-right: 5px;
        }
        
        .action-btn:hover {
            background: #475569;
        }
        
        .timer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid #334155;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-active {
            color: #10b981;
        }
        
        .stat-expired {
            color: #ef4444;
        }
        
        .stat-total {
            color: #60a5fa;
        }
        
        .stat-time {
            color: #f59e0b;
        }
        
        .hidden {
            display: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #10b981;
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.5s;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #ef4444;
        }
        
        .notification.warning {
            background: #f59e0b;
        }
        
        .expiring-soon {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .recharge-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #334155;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-key"></i> PAINEL ADMIN - Controle de Keys</h1>
            <p class="subtitle">Sistema de geração e gerenciamento de chaves para o Painel Oficial</p>
            <p style="color: #60a5fa; margin-top: 10px; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> Keys geradas aqui funcionam no Painel Oficial
            </p>
        </header>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-title">Keys Ativas</div>
                <div class="stat-value stat-active" id="active-count">0</div>
                <div class="stat-desc">Funcionando no Painel</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Keys Expiradas</div>
                <div class="stat-value stat-expired" id="expired-count">0</div>
                <div class="stat-desc">Tempo/uso esgotado</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Total de Keys</div>
                <div class="stat-value stat-total" id="total-count">0</div>
                <div class="stat-desc">Geradas no sistema</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Tempo Restante</div>
                <div class="stat-value stat-time" id="total-time">0h</div>
                <div class="stat-desc">Tempo total ativo</div>
            </div>
        </div>
        
        <div class="main-panel">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-plus-circle"></i> Gerar Nova Key</h2>
                <div class="form-group">
                    <label for="key-type">Tipo de Key:</label>
                    <select id="key-type">
                        <option value="time">Por Tempo (Horas/Dias)</option>
                        <option value="credits">Por Créditos (Usos)</option>
                    </select>
                </div>
                
                <div id="time-options">
                    <div class="form-group">
                        <label for="time-amount">Tempo de Validade:</label>
                        <input type="number" id="time-amount" min="1" max="720" value="24">
                        <select id="time-unit" style="margin-top: 10px; width: 100%;">
                            <option value="hours">Horas</option>
                            <option value="days">Dias</option>
                            <option value="weeks">Semanas</option>
                        </select>
                    </div>
                </div>
                
                <div id="credit-options" class="hidden">
                    <div class="form-group">
                        <label for="credit-amount">Quantidade de Créditos:</label>
                        <input type="number" id="credit-amount" min="1" max="1000" value="100">
                        <p style="margin-top: 5px; font-size: 0.9rem; color: #94a3b8;">Cada uso do Painel consumirá 1 crédito</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="key-prefix">Prefixo da Key (opcional):</label>
                    <input type="text" id="key-prefix" placeholder="Ex: PRO, VIP, TEST">
                </div>
                
                <button class="btn" id="generate-btn">
                    <i class="fas fa-key"></i> Gerar Key
                </button>
                
                <div id="key-result" class="hidden">
                    <div class="key-display active" id="generated-key">KEY-AQUI</div>
                    <p style="text-align: center; color: #94a3b8; margin-bottom: 15px;">Copie esta key e compartilhe com o usuário</p>
                    <button class="btn btn-success" id="copy-btn">
                        <i class="fas fa-copy"></i> Copiar Key
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title"><i class="fas fa-bolt"></i> Ativar/Verificar Key</h2>
                <div class="form-group">
                    <label for="input-key">Insira a Key:</label>
                    <input type="text" id="input-key" placeholder="Cole a key aqui para ativar/verificar">
                </div>
                
                <button class="btn btn-success" id="activate-btn">
                    <i class="fas fa-check-circle"></i> Verificar Key
                </button>
                
                <div id="key-status" class="hidden">
                    <div class="key-display" id="status-key-display">KEY-AQUI</div>
                    
                    <div style="margin: 20px 0;">
                        <h3 style="color: #60a5fa; margin-bottom: 10px;">Status da Key</h3>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Status:</span>
                            <span id="status-text">Ativa</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Tipo:</span>
                            <span id="type-text">Tempo</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Expira em:</span>
                            <span id="expiry-text" class="timer">24h 30m</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Créditos restantes:</span>
                            <span id="credits-text">100</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Gerada em:</span>
                            <span id="created-text">01/01/2023</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-warning" id="use-credit-btn">
                        <i class="fas fa-bolt"></i> Simular Uso (1 Crédito)
                    </button>
                    
                    <div class="recharge-section" id="recharge-section">
                        <h3 style="color: #60a5fa; margin-bottom: 10px;">Recarregar Key</h3>
                        <div class="form-group">
                            <label for="recharge-amount">Adicionar tempo/créditos:</label>
                            <input type="number" id="recharge-amount" min="1" max="1000" value="24">
                            <select id="recharge-type" style="margin-top: 10px; width: 100%;">
                                <option value="hours">Horas</option>
                                <option value="credits">Créditos</option>
                            </select>
                        </div>
                        <button class="btn" id="recharge-btn">
                            <i class="fas fa-sync-alt"></i> Recarregar Key
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card keys-list">
                <h2 class="card-title"><i class="fas fa-list"></i> Todas as Keys Geradas</h2>
                <div class="table-container">
                    <table id="keys-table">
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Tempo/Créditos</th>
                                <th>Expira em</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="keys-table-body">
                            <!-- Keys serão adicionadas aqui pelo JavaScript -->
                        </tbody>
                    </table>
                </div>
                <p style="text-align: center; margin-top: 15px; color: #94a3b8;">
                    <i class="fas fa-info-circle"></i> Estas keys funcionam no Painel Oficial dos usuários
                </p>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <span id="notification-text">Operação realizada com sucesso!</span>
    </div>

    <script>
        // ============================================
        // BANCO DE DADOS DAS KEYS - COMPARTILHADO
        // ============================================
        // NOME DA CHAVE NO localStorage: 'panel_keys_database'
        // Este mesmo nome deve ser usado no Painel Oficial
        
        let keysDatabase = JSON.parse(localStorage.getItem('panel_keys_database')) || [];
        let currentCheckingKey = null;
        
        // Elementos DOM
        const keyTypeSelect = document.getElementById('key-type');
        const timeOptions = document.getElementById('time-options');
        const creditOptions = document.getElementById('credit-options');
        const generateBtn = document.getElementById('generate-btn');
        const keyResult = document.getElementById('key-result');
        const generatedKey = document.getElementById('generated-key');
        const copyBtn = document.getElementById('copy-btn');
        const activateBtn = document.getElementById('activate-btn');
        const keyStatus = document.getElementById('key-status');
        const keysTableBody = document.getElementById('keys-table-body');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        
        // Elementos de estatísticas
        const activeCount = document.getElementById('active-count');
        const expiredCount = document.getElementById('expired-count');
        const totalCount = document.getElementById('total-count');
        const totalTime = document.getElementById('total-time');
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            updateKeysTable();
            updateStats();
            startTimer();
            
            // Alternar entre tempo e créditos
            keyTypeSelect.addEventListener('change', function() {
                if (this.value === 'time') {
                    timeOptions.classList.remove('hidden');
                    creditOptions.classList.add('hidden');
                } else {
                    timeOptions.classList.add('hidden');
                    creditOptions.classList.remove('hidden');
                }
            });
            
            // Gerar nova key
            generateBtn.addEventListener('click', generateKey);
            
            // Copiar key
            copyBtn.addEventListener('click', copyKey);
            
            // Verificar/Ativar key
            activateBtn.addEventListener('click', checkKey);
            
            // Usar crédito (simulação)
            document.getElementById('use-credit-btn').addEventListener('click', simulateUseCredit);
            
            // Recarregar key
            document.getElementById('recharge-btn').addEventListener('click', rechargeKey);
        });
        
        // Função para gerar uma nova key
        function generateKey() {
            const keyType = keyTypeSelect.value;
            const prefix = document.getElementById('key-prefix').value.trim();
            let keyData;
            
            // Gerar key única
            const key = generateUniqueKey(prefix);
            
            if (keyType === 'time') {
                const timeAmount = parseInt(document.getElementById('time-amount').value);
                const timeUnit = document.getElementById('time-unit').value;
                
                // Converter para horas
                let hours = timeAmount;
                if (timeUnit === 'days') hours = timeAmount * 24;
                if (timeUnit === 'weeks') hours = timeAmount * 24 * 7;
                
                keyData = {
                    key: key,
                    type: 'time',
                    status: 'active',
                    hoursRemaining: hours,
                    totalHours: hours,
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + (hours * 60 * 60 * 1000)).toISOString(),
                    // Adicionado: lastUsed para controle
                    lastUsed: null
                };
            } else {
                const creditAmount = parseInt(document.getElementById('credit-amount').value);
                
                keyData = {
                    key: key,
                    type: 'credits',
                    status: 'active',
                    creditsRemaining: creditAmount,
                    totalCredits: creditAmount,
                    createdAt: new Date().toISOString(),
                    // Adicionado: lastUsed para controle
                    lastUsed: null
                };
            }
            
            // Adicionar ao banco de dados
            keysDatabase.push(keyData);
            saveToLocalStorage();
            
            // Mostrar a key gerada
            generatedKey.textContent = key;
            keyResult.classList.remove('hidden');
            
            // Atualizar tabela e estatísticas
            updateKeysTable();
            updateStats();
            
            // Mostrar notificação
            showNotification('Key gerada com sucesso!', 'success');
            
            // Rolar para a key gerada
            keyResult.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Função para gerar uma key única
        function generateUniqueKey(prefix = '') {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let key = '';
            
            // Adicionar prefixo se fornecido
            if (prefix) key = prefix + '-';
            
            // Gerar parte aleatória
            for (let i = 0; i < 12; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
                if ((i + 1) % 4 === 0 && i < 11) key += '-';
            }
            
            // Verificar se a key já existe
            const existingKey = keysDatabase.find(k => k.key === key);
            if (existingKey) {
                // Se já existir, gerar outra
                return generateUniqueKey(prefix);
            }
            
            return key;
        }
        
        // Função para verificar/ativar uma key
        function checkKey() {
            const inputKey = document.getElementById('input-key').value.trim();
            
            if (!inputKey) {
                showNotification('Por favor, insira uma key para verificar', 'error');
                return;
            }
            
            // Encontrar a key no banco de dados
            const keyData = keysDatabase.find(k => k.key === inputKey);
            
            if (!keyData) {
                showNotification('Key não encontrada!', 'error');
                keyStatus.classList.add('hidden');
                return;
            }
            
            // Verificar status da key
            currentCheckingKey = keyData;
            
            // Atualizar expiração se for key de tempo
            if (keyData.type === 'time' && keyData.status === 'active') {
                const now = new Date();
                const expiresAt = new Date(keyData.expiresAt);
                
                if (now > expiresAt) {
                    keyData.status = 'expired';
                    keyData.hoursRemaining = 0;
                    saveToLocalStorage();
                }
            }
            
            // Atualizar a exibição do status
            updateKeyStatusDisplay(keyData);
            
            // Mostrar a seção de status
            keyStatus.classList.remove('hidden');
            
            // Rolar para o status
            keyStatus.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Função para atualizar a exibição do status da key
        function updateKeyStatusDisplay(keyData) {
            document.getElementById('status-key-display').textContent = keyData.key;
            
            // Definir classe de status
            const statusDisplay = document.getElementById('status-key-display');
            statusDisplay.className = 'key-display';
            
            if (keyData.status === 'active') {
                document.getElementById('status-text').textContent = 'Ativa';
                document.getElementById('status-text').style.color = '#10b981';
                statusDisplay.classList.add('active');
            } else {
                document.getElementById('status-text').textContent = 'Expirada';
                document.getElementById('status-text').style.color = '#ef4444';
                statusDisplay.classList.add('expired');
            }
            
            // Tipo
            document.getElementById('type-text').textContent = keyData.type === 'time' ? 'Tempo' : 'Créditos';
            
            // Expiração
            if (keyData.type === 'time') {
                if (keyData.status === 'active') {
                    const now = new Date();
                    const expiresAt = new Date(keyData.expiresAt);
                    const diffMs = expiresAt - now;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    
                    document.getElementById('expiry-text').textContent = `${diffHours}h ${diffMinutes}m`;
                    
                    // Adicionar classe de aviso se faltar menos de 1 hora
                    if (diffHours < 1) {
                        document.getElementById('expiry-text').classList.add('expiring-soon');
                    } else {
                        document.getElementById('expiry-text').classList.remove('expiring-soon');
                    }
                } else {
                    document.getElementById('expiry-text').textContent = 'Expirada';
                }
                
                // Esconder créditos
                document.getElementById('credits-text').parentElement.style.display = 'none';
                document.getElementById('use-credit-btn').style.display = 'none';
            } else {
                document.getElementById('expiry-text').textContent = 'N/A';
                document.getElementById('credits-text').textContent = `${keyData.creditsRemaining} / ${keyData.totalCredits}`;
                
                // Mostrar créditos
                document.getElementById('credits-text').parentElement.style.display = 'flex';
                
                // Mostrar botão de usar crédito apenas se a key estiver ativa
                if (keyData.status === 'active') {
                    document.getElementById('use-credit-btn').style.display = 'block';
                } else {
                    document.getElementById('use-credit-btn').style.display = 'none';
                }
            }
            
            // Data de criação
            const createdDate = new Date(keyData.createdAt);
            document.getElementById('created-text').textContent = createdDate.toLocaleDateString('pt-BR');
            
            // Mostrar/ocultar seção de recarga
            document.getElementById('recharge-section').style.display = 'block';
        }
        
        // Função para simular uso de crédito (apenas para teste no admin)
        function simulateUseCredit() {
            if (!currentCheckingKey || currentCheckingKey.type !== 'credits') return;
            
            if (currentCheckingKey.creditsRemaining <= 0) {
                showNotification('Key sem créditos disponíveis!', 'error');
                currentCheckingKey.status = 'expired';
                saveToLocalStorage();
                updateKeyStatusDisplay(currentCheckingKey);
                updateKeysTable();
                updateStats();
                return;
            }
            
            // Reduzir créditos
            currentCheckingKey.creditsRemaining--;
            currentCheckingKey.lastUsed = new Date().toISOString();
            
            // Se chegou a zero, expirar
            if (currentCheckingKey.creditsRemaining <= 0) {
                currentCheckingKey.status = 'expired';
                showNotification('Key expirou! Créditos esgotados.', 'warning');
            } else {
                showNotification('Crédito utilizado! Restam ' + currentCheckingKey.creditsRemaining + ' créditos.', 'success');
            }
            
            // Salvar e atualizar
            saveToLocalStorage();
            updateKeyStatusDisplay(currentCheckingKey);
            updateKeysTable();
            updateStats();
        }
        
        // Função para recarregar uma key
        function rechargeKey() {
            if (!currentCheckingKey) return;
            
            const rechargeAmount = parseInt(document.getElementById('recharge-amount').value);
            const rechargeType = document.getElementById('recharge-type').value;
            
            if (isNaN(rechargeAmount) || rechargeAmount <= 0) {
                showNotification('Insira uma quantidade válida', 'error');
                return;
            }
            
            // Recarregar conforme o tipo
            if (rechargeType === 'hours') {
                // Adicionar horas
                const hoursToAdd = rechargeAmount;
                
                if (currentCheckingKey.type === 'time') {
                    // Para keys de tempo
                    currentCheckingKey.hoursRemaining += hoursToAdd;
                    currentCheckingKey.totalHours += hoursToAdd;
                    
                    // Recalcular data de expiração
                    const now = new Date();
                    const newExpiresAt = new Date(now.getTime() + (currentCheckingKey.hoursRemaining * 60 * 60 * 1000));
                    currentCheckingKey.expiresAt = newExpiresAt.toISOString();
                } else {
                    // Para keys de créditos, converter horas em créditos (1 hora = 10 créditos)
                    const creditsToAdd = hoursToAdd * 10;
                    currentCheckingKey.creditsRemaining += creditsToAdd;
                    currentCheckingKey.totalCredits += creditsToAdd;
                }
            } else {
                // Adicionar créditos
                if (currentCheckingKey.type === 'credits') {
                    currentCheckingKey.creditsRemaining += rechargeAmount;
                    currentCheckingKey.totalCredits += rechargeAmount;
                } else {
                    // Para keys de tempo, converter créditos em horas (10 créditos = 1 hora)
                    const hoursToAdd = Math.floor(rechargeAmount / 10);
                    currentCheckingKey.hoursRemaining += hoursToAdd;
                    currentCheckingKey.totalHours += hoursToAdd;
                    
                    // Recalcular data de expiração
                    const now = new Date();
                    const newExpiresAt = new Date(now.getTime() + (currentCheckingKey.hoursRemaining * 60 * 60 * 1000));
                    currentCheckingKey.expiresAt = newExpiresAt.toISOString();
                }
            }
            
            // Reativar a key se estava expirada
            if (currentCheckingKey.status === 'expired') {
                currentCheckingKey.status = 'active';
            }
            
            // Salvar e atualizar
            saveToLocalStorage();
            updateKeyStatusDisplay(currentCheckingKey);
            updateKeysTable();
            updateStats();
            
            showNotification('Key recarregada com sucesso!', 'success');
        }
        
        // Função para atualizar a tabela de keys
        function updateKeysTable() {
            keysTableBody.innerHTML = '';
            
            if (keysDatabase.length === 0) {
                keysTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-key" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            Nenhuma key gerada ainda
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordenar por data (mais recentes primeiro)
            const sortedKeys = [...keysDatabase].sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );
            
            sortedKeys.forEach(keyData => {
                const row = document.createElement('tr');
                
                // Status da key
                let statusClass, statusText;
                if (keyData.status === 'active') {
                    statusClass = 'status-active';
                    statusText = 'Ativa';
                } else {
                    statusClass = 'status-expired';
                    statusText = 'Expirada';
                }
                
                // Tempo/Créditos restantes
                let remainingText;
                if (keyData.type === 'time') {
                    if (keyData.status === 'active') {
                        const now = new Date();
                        const expiresAt = new Date(keyData.expiresAt);
                        const diffMs = expiresAt - now;
                        
                        if (diffMs > 0) {
                            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                            remainingText = `${diffHours}h ${diffMinutes}m`;
                        } else {
                            remainingText = 'Expirada';
                        }
                    } else {
                        remainingText = 'Expirada';
                    }
                } else {
                    remainingText = `${keyData.creditsRemaining} créditos`;
                }
                
                // Data de expiração
                let expiryText;
                if (keyData.type === 'time' && keyData.expiresAt) {
                    const expiryDate = new Date(keyData.expiresAt);
                    expiryText = expiryDate.toLocaleDateString('pt-BR');
                } else {
                    expiryText = 'Por créditos';
                }
                
                // Último uso
                let lastUsedText = 'Nunca usado';
                if (keyData.lastUsed) {
                    const lastUsedDate = new Date(keyData.lastUsed);
                    lastUsedText = lastUsedDate.toLocaleDateString('pt-BR');
                }
                
                row.innerHTML = `
                    <td><strong>${keyData.key}</strong></td>
                    <td>${keyData.type === 'time' ? 'Tempo' : 'Créditos'}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>${remainingText}</td>
                    <td>${expiryText}</td>
                    <td>
                        <button class="action-btn" onclick="checkKeyFromTable('${keyData.key}')">
                            <i class="fas fa-search"></i> Verificar
                        </button>
                        <button class="action-btn" onclick="deleteKey('${keyData.key}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                `;
                
                keysTableBody.appendChild(row);
            });
        }
        
        // Função para verificar key a partir da tabela
        window.checkKeyFromTable = function(key) {
            document.getElementById('input-key').value = key;
            checkKey();
        };
        
        // Função para excluir key
        window.deleteKey = function(key) {
            if (confirm('Tem certeza que deseja excluir esta key?')) {
                keysDatabase = keysDatabase.filter(k => k.key !== key);
                saveToLocalStorage();
                updateKeysTable();
                updateStats();
                showNotification('Key excluída com sucesso!', 'success');
                
                // Se estiver verificando a key excluída, esconder o painel de status
                if (currentCheckingKey && currentCheckingKey.key === key) {
                    keyStatus.classList.add('hidden');
                }
            }
        };
        
        // Função para atualizar estatísticas
        function updateStats() {
            const activeKeys = keysDatabase.filter(k => k.status === 'active');
            const expiredKeys = keysDatabase.filter(k => k.status === 'expired');
            
            // Calcular tempo total restante (em horas)
            let totalHoursRemaining = 0;
            activeKeys.forEach(key => {
                if (key.type === 'time' && key.status === 'active') {
                    const now = new Date();
                    const expiresAt = new Date(key.expiresAt);
                    const diffMs = expiresAt - now;
                    
                    if (diffMs > 0) {
                        totalHoursRemaining += Math.floor(diffMs / (1000 * 60 * 60));
                    }
                } else if (key.type === 'credits') {
                    // Converter créditos em horas (10 créditos = 1 hora)
                    totalHoursRemaining += Math.floor(key.creditsRemaining / 10);
                }
            });
            
            // Atualizar contadores
            activeCount.textContent = activeKeys.length;
            expiredCount.textContent = expiredKeys.length;
            totalCount.textContent = keysDatabase.length;
            totalTime.textContent = `${totalHoursRemaining}h`;
        }
        
        // Timer para atualizar automaticamente o tempo restante
        function startTimer() {
            // Atualizar a cada minuto
            setInterval(() => {
                updateKeysTable();
                updateStats();
                
                // Se estiver verificando uma key, atualizar seu status também
                if (currentCheckingKey) {
                    const keyData = keysDatabase.find(k => k.key === currentCheckingKey.key);
                    if (keyData) {
                        updateKeyStatusDisplay(keyData);
                        currentCheckingKey = keyData;
                    }
                }
            }, 60000); // 1 minuto
        }
        
        // Função para copiar key para a área de transferência
        function copyKey() {
            const keyText = generatedKey.textContent;
            navigator.clipboard.writeText(keyText)
                .then(() => {
                    showNotification('Key copiada para a área de transferência!', 'success');
                })
                .catch(err => {
                    showNotification('Erro ao copiar key', 'error');
                    console.error('Erro ao copiar: ', err);
                });
        }
        
        // Função para mostrar notificações
        function showNotification(message, type = 'success') {
            notificationText.textContent = message;
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.classList.add('error');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            }
            
            notification.classList.add('show');
            
            // Ocultar após 3 segundos
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // ============================================
        // SALVAR NO localStorage - CHAVE COMPARTILHADA
        // ============================================
        function saveToLocalStorage() {
            // SALVA COM O NOME QUE O PAINEL OFICIAL VAI LER
            localStorage.setItem('panel_keys_database', JSON.stringify(keysDatabase));
        }
    </script>
</body>
</html>
